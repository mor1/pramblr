#!/usr/bin/env -S uv run --env-file /home/mort/.local/bin/.env-pramblr --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#   "gpxplotter>=0.2.12",
#   "rich>=13.7.1",
#   "click>=8.1.8",
#   "yaml-rs>=0.0.10",
# ]
# ///

# SPDX-FileCopyrightText: (C) Richard Mortier <mort@cantab.net>
#
# SPDX-License-Identifier: BSD-3-Clause

"""Produce Ramblr-like pages from GPX files and photos."""

# pyright: reportAny=false
# pyright: reportAttributeAccessIssue=false
# pyright: reportMissingParameterType=false
# pyright: reportPrivateLocalImportUsage=false
# pyright: reportUnknownArgumentType=false
# pyright: reportUnknownMemberType=false
# pyright: reportUnknownParameterType=false
# pyright: reportUnknownVariableType=false
# pyright: reportUntypedFunctionDecorator=false
# pyright: reportOptionalMemberAccess

import logging
from pathlib import Path

import click
import yaml_rs as yaml
from rich.console import Console
from rich.logging import RichHandler

errcon = Console(stderr=True)
logging.basicConfig(
    level="INFO",
    format="%(message)s",
    datefmt="[%X]",
    handlers=[RichHandler(console=errcon, rich_tracebacks=True)],
)
log = logging.getLogger(__name__)


@click.command(context_settings={"show_default": True, "ignore_unknown_options": True})
@click.argument("configf", required=False, type=click.File("r"))
@click.option("--debug", default=False, is_flag=True, help="Turn on verbose logging.")
@click.option(
    "--outf",
    required=False,
    type=click.Path(dir_okay=False, writable=True, allow_dash=True, path_type=Path),
)
@click.option(
    "--gpxs",
    type=click.Path(exists=True, dir_okay=True, path_type=Path),
    multiple=True,
    help="GPX files of the track.",
)
@click.option(
    "--photos",
    type=click.Path(exists=True, dir_okay=True, path_type=Path),
    multiple=True,
    help="Photos from the track.",
)
def pramblr(
    configf: click.File,
    debug: bool,
    outf: click.File,
    gpxs: tuple[Path, ...],
    photos: tuple[Path, ...],
) -> None:
    """."""

    # verbose logging
    if debug:
        log.setLevel(logging.DEBUG)

    # parse configuration if provided
    config = yaml.loads(configf.read()) if configf else None
    log.debug(config)

    # output file
    outf = click.open_file(config.get("outf", outf) if config else outf, mode="wb")
    log.debug(f"{outf=}")

    # build list of GPX tracks
    gpxs = tuple(Path(p) for p in config.get("gpxs", gpxs)) if config else gpxs
    log.debug(f"{gpxs=}")

    # build list of photos
    photos = tuple(Path(p) for p in config.get("photos", photos)) if config else photos
    log.debug(f"{photos=}")

if __name__ == "__main__":
    pramblr()
